(window.webpackJsonp=window.webpackJsonp||[]).push([[87],{534:function(s,e,t){"use strict";t.r(e);var a=t(21),n=Object(a.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"定时任务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#定时任务"}},[s._v("#")]),s._v(" 定时任务")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://apscheduler.readthedocs.io/en/latest/index.html",target:"_blank",rel:"noopener noreferrer"}},[t("code",[s._v("APScheduler")]),t("OutboundLink")],1),s._v(" —— Advanced Python Scheduler")]),s._v(" "),t("blockquote",[t("p",[s._v("Advanced Python Scheduler (APScheduler) is a Python library that lets you schedule your Python code to be executed later, either just once or periodically. You can add new jobs or remove old ones on the fly as you please. If you store your jobs in a database, they will also survive scheduler restarts and maintain their state. When the scheduler is restarted, it will then run all the jobs it should have run while it was offline.")])]),s._v(" "),t("h2",{attrs:{id:"从-v1-迁移"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#从-v1-迁移"}},[s._v("#")]),s._v(" 从 v1 迁移")]),s._v(" "),t("p",[t("code",[s._v("APScheduler")]),s._v(" 作为 "),t("code",[s._v("nonebot")]),s._v(" v1 的可选依赖，为众多 bot 提供了方便的定时任务功能。"),t("code",[s._v("nonebot2")]),s._v(" 已将 "),t("code",[s._v("APScheduler")]),s._v(" 独立为 "),t("code",[s._v("nonebot_plugin_apscheduler")]),s._v(" 插件，你可以在 "),t("a",{attrs:{href:"https://v2.nonebot.dev/plugin-store.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("插件广场"),t("OutboundLink")],1),s._v(" 中找到它。")]),s._v(" "),t("p",[s._v("相比于 "),t("code",[s._v("nonebot")]),s._v(" v1 ，只需要安装插件并修改 "),t("code",[s._v("scheduler")]),s._v(" 的导入方式即可完成迁移。")]),s._v(" "),t("h2",{attrs:{id:"安装插件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装插件"}},[s._v("#")]),s._v(" 安装插件")]),s._v(" "),t("h3",{attrs:{id:"通过-nb-cli"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#通过-nb-cli"}},[s._v("#")]),s._v(" 通过 nb-cli")]),s._v(" "),t("p",[s._v("如正在使用 "),t("code",[s._v("nb-cli")]),s._v(" 构建项目，你可以从插件市场复制安装命令或手动输入以下命令以添加 "),t("code",[s._v("nonebot_plugin_apscheduler")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("nb plugin "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" nonebot_plugin_apscheduler\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),t("p",[t("code",[s._v("nb-cli")]),s._v(" 默认通过 "),t("code",[s._v("pypi")]),s._v(" 安装，你可以使用 "),t("code",[s._v("-i [mirror]")]),s._v(" 或 "),t("code",[s._v("--index [mirror]")]),s._v(" 来使用镜像源安装。")])]),s._v(" "),t("h3",{attrs:{id:"通过-poetry"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#通过-poetry"}},[s._v("#")]),s._v(" 通过 poetry")]),s._v(" "),t("p",[s._v("执行以下命令以添加 "),t("code",[s._v("nonebot_plugin_apscheduler")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("poetry "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" nonebot-plugin-apscheduler\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),t("p",[s._v("由于稍后我们将使用 "),t("code",[s._v("nonebot.require()")]),s._v(" 方法进行导入，所以无需额外的 "),t("code",[s._v("nonebot.load_plugin()")])])]),s._v(" "),t("h2",{attrs:{id:"快速上手"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#快速上手"}},[s._v("#")]),s._v(" 快速上手")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("在需要设置定时任务的插件中，通过 "),t("code",[s._v("nonebot.require")]),s._v(" 从 "),t("code",[s._v("nonebot_plugin_apscheduler")]),s._v(" 导入 "),t("code",[s._v("scheduler")]),s._v(" 对象")])]),s._v(" "),t("li",[t("p",[s._v("在该对象的基础上，根据 "),t("code",[s._v("APScheduler")]),s._v(" 的使用方法进一步配置定时任务")])])]),s._v(" "),t("p",[s._v("将上述步骤归纳为最小实现的代码如下：")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" nonebot "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" require\n\nscheduler "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" require"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'nonebot_plugin_apscheduler'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("scheduler\n\n"),t("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@scheduler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("scheduled_job")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'cron'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" hour"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'*/2'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("id")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xxx'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" args"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" kwargs"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("arg2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("run_every_2_hour")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("arg1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" arg2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("pass")]),s._v("\n\nscheduler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("add_job"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("run_every_day_from_program_start"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"interval"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" days"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("id")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xxx"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("h2",{attrs:{id:"分步进行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#分步进行"}},[s._v("#")]),s._v(" 分步进行")]),s._v(" "),t("h3",{attrs:{id:"导入-scheduler-对象"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#导入-scheduler-对象"}},[s._v("#")]),s._v(" 导入 scheduler 对象")]),s._v(" "),t("p",[s._v("为了使插件能够实现定时任务，需要先将 "),t("code",[s._v("scheduler")]),s._v(" 对象导入插件。")]),s._v(" "),t("p",[t("code",[s._v("nonebot2")]),s._v(" 提供了 "),t("code",[s._v("nonebot.require")]),s._v(" 方法来实现导入其他插件的内容，此处我们使用这个方法来导入 "),t("code",[s._v("scheduler")]),s._v(" 对象。")]),s._v(" "),t("p",[t("code",[s._v("nonebot")]),s._v(" 使用的 "),t("code",[s._v("scheduler")]),s._v(" 对象为 "),t("code",[s._v("AsyncScheduler")]),s._v(" 。")]),s._v(" "),t("blockquote",[t("p",[s._v("使用该方法传入的插件本身也需要有对应实现，关于该方法的更多介绍可以参阅 "),t("router-link",{attrs:{to:"./export-and-require.html"}},[s._v("这里")])],1)]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" nonebot "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" require\n\nscheduler "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" require"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'nonebot_plugin_apscheduler'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("scheduler\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"编写定时任务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编写定时任务"}},[s._v("#")]),s._v(" 编写定时任务")]),s._v(" "),t("p",[s._v("由于本部分为标准的通过 "),t("code",[s._v("APScheduler")]),s._v(" 配置定时任务，有关指南请参阅 "),t("a",{attrs:{href:"https://apscheduler.readthedocs.io/en/latest/userguide.html#adding-jobs",target:"_blank",rel:"noopener noreferrer"}},[s._v("APScheduler 官方文档"),t("OutboundLink")],1),s._v("。")]),s._v(" "),t("h3",{attrs:{id:"配置插件选项"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置插件选项"}},[s._v("#")]),s._v(" 配置插件选项")]),s._v(" "),t("p",[s._v("根据项目的 "),t("code",[s._v(".env")]),s._v(" 文件设置，向 "),t("code",[s._v(".env.*")]),s._v(" 或 "),t("code",[s._v("bot.py")]),s._v(" 文件添加 "),t("code",[s._v("nonebot_plugin_apscheduler")]),s._v(" 的可选配置项")]),s._v(" "),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),t("p",[t("code",[s._v(".env.*")]),s._v(" 文件的编写应遵循 nonebot2 对 "),t("code",[s._v(".env.*")]),s._v(" 文件的编写要求")])]),s._v(" "),t("h4",{attrs:{id:"apscheduler-autostart"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#apscheduler-autostart"}},[s._v("#")]),s._v(" "),t("code",[s._v("apscheduler_autostart")])]),s._v(" "),t("p",[s._v("类型："),t("code",[s._v("bool")])]),s._v(" "),t("p",[s._v("默认值："),t("code",[s._v("True")])]),s._v(" "),t("p",[s._v("是否自动启动 "),t("code",[s._v("APScheduler")]),s._v("。")]),s._v(" "),t("p",[s._v("对于大多数情况，我们需要在 "),t("code",[s._v("nonebot2")]),s._v(" 项目被启动时启动定时任务，则此处设为 "),t("code",[s._v("true")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("APSCHEDULER_AUTOSTART")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[s._v("nonebot"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("init"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("apscheduler_autostart"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h4",{attrs:{id:"apscheduler-config"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#apscheduler-config"}},[s._v("#")]),s._v(" "),t("code",[s._v("apscheduler_config")])]),s._v(" "),t("p",[s._v("类型："),t("code",[s._v("dict")])]),s._v(" "),t("p",[s._v("默认值："),t("code",[s._v('{"apscheduler.timezone": "Asia/Shanghai"}')])]),s._v(" "),t("p",[t("code",[s._v("APScheduler")]),s._v(" 相关配置。修改/增加其中配置项需要确保 "),t("code",[s._v("prefix: apscheduler")]),s._v("。")]),s._v(" "),t("p",[s._v("对于 "),t("code",[s._v("APScheduler")]),s._v(" 的相关配置，请参阅 "),t("a",{attrs:{href:"https://apscheduler.readthedocs.io/en/latest/userguide.html#scheduler-config",target:"_blank",rel:"noopener noreferrer"}},[s._v("scheduler-config"),t("OutboundLink")],1),s._v(" 和 "),t("a",{attrs:{href:"https://apscheduler.readthedocs.io/en/latest/modules/schedulers/base.html#apscheduler.schedulers.base.BaseScheduler",target:"_blank",rel:"noopener noreferrer"}},[s._v("BaseScheduler"),t("OutboundLink")],1)]),s._v(" "),t("blockquote",[t("p",[s._v("官方文档在绝大多数时候能提供最准确和最具时效性的指南")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("APSCHEDULER_CONFIG")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apscheduler.timezone"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Asia/Shanghai"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[s._v("nonebot"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("init"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("apscheduler_config"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apscheduler.timezone"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Asia/Shanghai"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])])}),[],!1,null,null,null);e.default=n.exports}}]);