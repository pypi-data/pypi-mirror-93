# xt_config_schema.yaml: yaml file that describes legal entries for DEFAULT and LOCAL XT config files.

# predefined keys: $record-types, $repeat, $opt, $select, $select-key, $select-records
# predefined values: $str, $bool, $int, $num, $str-list, $rec

$reference-types:
    # defines a reference a child of the specified section 
    ref-store: stores
    ref-external: external-services
    ref-target: compute-targets
    ref-batch-image: azure-batch-images
    ref-prefix: script-launch-prefix
    ref-setup: setups
    ref-provider: providers
    ref-docker: dockers

$record-types:
    rec_philly: {type: "philly"}
    rec_batch: {type: "batch", key: $str, url: $str }
    rec_aml: {type: "aml", subscription-id: $str, resource-group: $str}
    rec_itp: {type: "itp", subscription-id: $str, resource-group: $str}
    rec_storage: {type: "storage", provider: $ref-provider, $opt: {key: $str, path: $str}}
    rec_mongo: {type: "mongo", connection-string: $str}
    rec_odbc: {type: "odbc", connection-string: $str}
    rec_vault: {type: "vault", url: $str, $opt: {secret-name: $str}}
    rec_registry: {type: "registry", login-server: $str, $opt: {username: $str, password: $str, login: $bool}}

    rec_target: {service: $ref-external, $opt: 
        {vm-size: $str, azure-image: $ref-batch-image, low-pri: $bool, box-class: $ref-prefix, docker: $ref-docker, 
        setup: $ref-setup, boxes: $str-list, vc: $str, cluster: $str, queue: $str, sku: $str, compute: $str, nodes: $int }}

    rec_docker: {image: $str, $opt: {registry: $str }}
    rec_setup: { $opt: {pre-cmds: $str-list, activate: $str, conda-packages: $str-list, pip-packages: $str-list, 
        python-path: $str-list, other-cmds: $str-list, use-sudo: $bool, install-blobfuse: $bool } }
    rec_image: {offer: $str, publisher: $str, sku: $str, node-agent-sku-id: $str, version: $str}
    rec_box: {address: $str, max-runs: $int, $opt: {os: $str, actions: $str-list, box-class: $ref-prefix, docker: $ref-docker, setup: $ref-setup}}
    rec_store: {storage: $ref-external, database: $ref-external, vault: $ref-external, target: $ref-target, $opt: {track-storage: $bool}}
    rec_filter: {prop: $str, type: $str, $opt: {op: $str, value: $str}}

external-services:
    $repeat:
        $str: {$select: {$select-key: type, $select-records: {philly: $rec_philly, batch: $rec_batch, aml: $rec_aml, 
            itp: $rec_itp, storage: $rec_storage, mongo: $rec_mongo, odbc: $rec_odbc, vault: $rec_vault, registry: $rec_registry} } }

store: $ref-store

stores:
    $repeat:
        $str: $rec_store

compute-targets:
    $repeat:
        $str: $rec_target

dockers:
    $repeat:
        $str: $rec_docker

setups:
    $repeat:
        $str: $rec_setup

general:
    advanced-mode: $bool
    username: $str
    workspace: $str
    experiment: $str
    feedback: $bool
    run-cache-dir: $str
    distributed: $bool
    direct-run: $bool
    quick-start: $bool
    env-vars: $rec
    authentication: [auto, browser, device-code]
    remote-control: $bool
    monitor: $str
    max-run-workers: $int

    # TODO: move to new metrics section
    primary-metric: $str
    maximize-metric: $bool
    step-name: $str

code:
    code-dirs: $str-list
    code-upload: $bool
    code-zip: [none, fast, compress] 
    code-omit: $str-list
    xtlib-upload: $bool
    working-dir: $str

after-files:
    after-dirs: $str-list
    after-upload: $bool
    after-omit: $str-list

data:
    data-local: $str
    data-upload: $bool
    data-share-path: $str
    data-action: [none, download, mount]
    data-omit: $str-list
    data-writable: $bool

model:
    model-local: $str
    model-share-path: $str
    model-action: [none, dowhnload, mount]
    model-writable: $bool

database:
    update-job-stats: $bool
    update-run-stats: $bool       
    update-node-stats: $bool       
    add-log-records: $bool        
    buffer-metrics: $int
    max-log-workers: $int
    max-retries: $int
    fake-error-percent: $num
    chunk-size: $int
    max-backoff: $num
    max-run-delay: $num
    reset-connection: $bool                 # when true, new connection is established before any error is retried
    extended-logging: $bool                 # when true, all ODBC calls and errors are logged to console

logging:
    log: $bool
    notes: [none, before, after, all]
    mirror-files: $str
    mirror-dest: [none, storage]
    capture-setup-cmds: $bool
    pip-freeze: $bool
    log-reports: $bool
    merge-batch-logs: $bool

internal:
    console: [none, normal, diagnostics, detail]
    stack-trace: $bool
    auto-start: $bool

commands: $str-list
  
aml-options:
    use-gpu: $bool
    framework: $str
    fw-version: $str
    # user-managed: $bool
    distributed-training: [mpi, gloo, nccl]
    max-seconds: $int

early-stopping:
    early-policy: [none, bandit, median, truncation]
    delay-evaluation: $num
    evaluation-interval: $num
    slack-factor: $num
    slack-amount: $num
    truncation-percentage: $num

hyperparameter-search:
    option-prefix: $str
    aggregate-dest: [job, experiment, none]
    search-type: [random, grid, bayesian, dgd]
    static-search: $bool
    max-minutes: $num
    max-runs: $int
    concurrent: $int
    hp-config: $str
    fn-generated-config: $str

hyperparameter-explorer:
    hx-cache-dir: $str
    steps-name: $str
    log-interval-name: $str
    time-name: $str
    sample-efficiency-name: $str
    success-rate-name: $str

plots:
    highlight: $str
    color-highlight: $str

run-reports:
    sort: $str
    group: $str
    number-groups: $bool
    reverse: $bool
    max-width: $int
    precision: $int
    significance: $int
    max-fixed-length: $int
    uppercase-hdr: $bool
    right-align-numeric: $bool
    truncate-with-ellipses: $bool
    status: $str
    report-rollup: $bool
    columns: $str-list
    last: $int
    count: $bool
    highlight: $str
    color-highlight: $str
    color-hdr: $str
    
job-reports:
    sort: $str
    reverse: $bool
    max-width: $int
    precision: $int
    significance: $int
    max-fixed-length: $int
    uppercase-hdr: $bool
    right-align-numeric: $bool
    truncate-with-ellipses: $bool
    columns: $str-list
    last: $int

node-reports:
    sort: $str
    reverse: $bool
    max-width: $int
    precision: $int
    significance: $int
    max-fixed-length: $int
    uppercase-hdr: $bool
    right-align-numeric: $bool
    truncate-with-ellipses: $bool
    columns: $str-list
    last: $int

tensorboard:
    template: $str

script-launch-prefix:
    windows: $str
    linux: $str
    dsvm: $str
    azureml: $str
    philly: $str
    itp: $str

azure-batch-images:
    $repeat:
        $str: $rec_image

user-filters:
    $repeat:
        $str: $rec_filter

boxes:
    $repeat:
        $str: $rec_box

providers:
    command: 
        $repeat: {$str: $str}

    compute: 
        $repeat: {$str: $str}

    hp-search: 
        $repeat: {$str: $str}

    storage: 
        $repeat: {$str: $str}


