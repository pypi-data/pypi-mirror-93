{"version":3,"sources":["utils.js","AgGrid.tsx","index.tsx"],"names":["deepMap","obj","fn","deepMapper","val","Array","isArray","map","Object","keys","reduce","res","key","mapObject","AgGrid","props","frameDtypes","api","columnApi","columnFormaters","manualUpdateRequested","allowUnsafeJsCode","fitColumnsOnGridLoad","gridOptions","convertJavascriptCodeOnGridOptions","convertStringToFunction","render","assign","console","warn","className","style","defineContainerHeight","ManualUpdateButton","manual_update","onClick","e","returnGridValue","onGridReady","rowData","state","args","row_data","gridHeight","height","enable_enterprise_modules","ModuleRegistry","registerModules","AllModules","AllCommunityModules","frame_dtypes","update_mode","allow_unsafe_jscode","fit_columns_on_grid_load","columnTypes","filter","filterParams","comparator","filterValue","cellValue","compareAsc","parseISO","valueFormatter","params","dateFormatter","value","column","colDef","custom_format_string","numberFormatter","precision","currencyFormatter","custom_currency_symbol","duration","humanize","v","JS_PLACEHOLDER","match","RegExp","exec","funcStr","Function","this","updateMode","addEventListener","event","setUpdateMode","fitColumns","sizeColumnsToFit","autoSizeAllColumns","isoString","formaterString","date","format","number","currencySymbol","n","Number","parseFloat","isNaN","toFixed","returnData","data_return_mode","forEachLeafNode","row","push","data","forEachNodeAfterFilter","group","forEachNodeAfterFilterAndSort","returnValue","originalDtypes","selectedRows","getSelectedRows","Streamlit","setComponentValue","width","reload_data","StreamlitComponentBase","withStreamlitConnection","ReactDOM","StrictMode","document","getElementById"],"mappings":"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","file":"static/js/main.bd072d4f.chunk.js","sourcesContent":["// stole from https://github.com/andfanilo/streamlit-echarts/blob/master/streamlit_echarts/frontend/src/utils.js Thanks andfanilo\r\nfunction mapObject(obj, fn) {\r\n    return Object.keys(obj).reduce((res, key) => {\r\n        res[key] = fn(obj[key])\r\n        return res\r\n    }, {})\r\n}\r\n\r\nfunction deepMap(obj, fn) {\r\n    const deepMapper = (val) =>\r\n        val !== null && typeof val === \"object\" ? deepMap(val, fn) : fn(val)\r\n    if (Array.isArray(obj)) {\r\n        return obj.map(deepMapper)\r\n    }\r\n    if (typeof obj === \"object\") {\r\n        return mapObject(obj, deepMapper)\r\n    }\r\n    return obj\r\n}\r\n\r\nexport default deepMap\r\n","import {\r\n  Streamlit,\r\n  StreamlitComponentBase,\r\n  withStreamlitConnection\r\n} from \"streamlit-component-lib\";\r\n\r\nimport React, { ReactNode } from \"react\"\r\n\r\nimport { AgGridReact } from '@ag-grid-community/react';\r\nimport { ColumnApi, GridApi } from '@ag-grid-community/core'\r\nimport { ModuleRegistry } from '@ag-grid-community/core';\r\nimport { AllCommunityModules } from '@ag-grid-community/all-modules'\r\nimport { AllModules } from '@ag-grid-enterprise/all-modules'\r\n\r\nimport '@ag-grid-community/core/dist/styles/ag-grid.css';\r\nimport '@ag-grid-community/core/dist/styles/ag-theme-balham.css';\r\n\r\nimport { parseISO, compareAsc } from 'date-fns'\r\nimport { format } from 'date-fns-tz'\r\nimport deepMap from \"./utils\"\r\nimport { Moment, duration } from \"moment\";\r\n\r\n\r\n\r\ninterface State {\r\n  rowData: any\r\n  gridHeight: number\r\n}\r\n\r\nclass AgGrid extends StreamlitComponentBase<State> {\r\n  private frameDtypes: any\r\n  private api!: GridApi;\r\n  private columnApi!: ColumnApi\r\n  private columnFormaters: any\r\n  private manualUpdateRequested: boolean = false\r\n  private allowUnsafeJsCode: boolean = false\r\n  private fitColumnsOnGridLoad: boolean = false\r\n  private gridOptions: any\r\n\r\n  constructor(props: any) {\r\n    super(props)\r\n    this.state = {\r\n      rowData: props.args.row_data,\r\n      gridHeight: this.props.args.height\r\n    }\r\n\r\n    if (props.args.enable_enterprise_modules) {\r\n      ModuleRegistry.registerModules(AllModules);\r\n    } else {\r\n      ModuleRegistry.registerModules(AllCommunityModules);\r\n    }\r\n\r\n    this.frameDtypes = this.props.args.frame_dtypes\r\n    this.manualUpdateRequested = (this.props.args.update_mode === 1)\r\n    this.allowUnsafeJsCode = this.props.args.allow_unsafe_jscode\r\n    this.fitColumnsOnGridLoad = this.props.args.fit_columns_on_grid_load\r\n    this.gridOptions = this.props.args.gridOptions\r\n\r\n    this.columnFormaters = {\r\n      columnTypes: {\r\n        'dateColumnFilter': {\r\n          filter: 'agDateColumnFilter',\r\n          filterParams: {\r\n            comparator: (filterValue: any, cellValue: string) => compareAsc(parseISO(cellValue), filterValue)\r\n          }\r\n        },\r\n        'numberColumnFilter': {\r\n          filter: 'agNumberColumnFilter'\r\n        },\r\n        'shortDateTimeFormat': {\r\n          valueFormatter: (params: any) => this.dateFormatter(params.value, \"dd/MM/yyyy HH:mm\"),\r\n        },\r\n        'customDateTimeFormat': {\r\n          valueFormatter: (params: any) => this.dateFormatter(params.value, params.column.colDef.custom_format_string),\r\n        },\r\n        'customNumericFormat': {\r\n          valueFormatter: (params: any) => this.numberFormatter(params.value, params.column.colDef.precision ?? 2),\r\n        },\r\n        'customCurrencyFormat': {\r\n          valueFormatter: (params: any) => this.currencyFormatter(params.value, params.column.colDef.custom_currency_symbol),\r\n        },\r\n        'timedeltaFormat': {\r\n          valueFormatter: (params: any) => duration(params.value).humanize(true)\r\n        },\r\n      }\r\n    }\r\n  }\r\n\r\n  static getDerivedStateFromProps(props: any, state: any) {\r\n    if (props.args.reload_data) {\r\n      return {\r\n        rowData: props.args.row_data,\r\n        gridHeight: props.args.height\r\n      }\r\n    } else {\r\n      return {\r\n        gridHeight: props.args.height\r\n      }\r\n    }\r\n  }\r\n\r\n  private convertStringToFunction(v: string) {\r\n    const JS_PLACEHOLDER = \"--x_x--0_0--\"\r\n\r\n    let funcReg = new RegExp(\r\n      `${JS_PLACEHOLDER}\\\\s*(function\\\\s*.*)\\\\s*${JS_PLACEHOLDER}`\r\n    )\r\n\r\n    let match = funcReg.exec(v)\r\n\r\n    if (match) {\r\n      const funcStr = match[1]\r\n      return new Function(\"return \" + funcStr)()\r\n\r\n    } else {\r\n      return v\r\n    }\r\n  }\r\n\r\n  private convertJavascriptCodeOnGridOptions = (obj: object) => {\r\n    return deepMap(obj, this.convertStringToFunction)\r\n  }\r\n\r\n  private setUpdateMode() {\r\n    if (this.manualUpdateRequested) {\r\n      return //If manual update is set, no listeners will be added\r\n    }\r\n\r\n    let updateMode = this.props.args.update_mode\r\n\r\n    if ((updateMode & 2) === 2) {\r\n      this.api.addEventListener('cellValueChanged', (e: any) => this.returnGridValue(e))\r\n    }\r\n\r\n    if ((updateMode & 4) === 4) {\r\n      this.api.addEventListener('selectionChanged', (e: any) => this.returnGridValue(e))\r\n    }\r\n\r\n    if ((updateMode & 8) === 8) {\r\n      this.api.addEventListener('filterChanged', (e: any) => this.returnGridValue(e))\r\n    }\r\n\r\n    if ((updateMode & 16) === 16) {\r\n      this.api.addEventListener('sortChanged', (e: any) => this.returnGridValue(e))\r\n    }\r\n  }\r\n\r\n  private onGridReady(event: any) {\r\n    this.api = event.api\r\n    this.columnApi = event.columnApi\r\n\r\n    this.setUpdateMode()\r\n    this.api.addEventListener('firstDataRendered', (e: any) => this.fitColumns())\r\n  }\r\n\r\n  private fitColumns() {\r\n    if (this.fitColumnsOnGridLoad) {\r\n      this.api.sizeColumnsToFit()\r\n    }\r\n    else {\r\n      this.columnApi.autoSizeAllColumns()\r\n    }\r\n  }\r\n\r\n  private dateFormatter(isoString: string, formaterString: string): String {\r\n    try {\r\n      let date = parseISO(isoString)\r\n      return format(date, formaterString)\r\n    } catch {\r\n      return isoString\r\n    }\r\n    finally { }\r\n  }\r\n\r\n  private currencyFormatter(number: any, currencySymbol: string): String {\r\n    let n = Number.parseFloat(number)\r\n    if (!Number.isNaN(n)) {\r\n      return currencySymbol + n.toFixed(2)\r\n    } else {\r\n      return number\r\n    }\r\n  }\r\n\r\n  private numberFormatter(number: any, precision: number): String {\r\n    let n = Number.parseFloat(number)\r\n    if (!Number.isNaN(n)) {\r\n      return n.toFixed(precision)\r\n    } else {\r\n      return number\r\n    }\r\n  }\r\n\r\n  private returnGridValue(e: any) {\r\n    let returnData: any[] = []\r\n    let returnMode = this.props.args.data_return_mode\r\n\r\n    switch (returnMode) {\r\n      case 0: //ALL_DATA\r\n        this.api.forEachLeafNode((row) => returnData.push(row.data))\r\n        break;\r\n\r\n      case 1: //FILTERED_DATA\r\n        this.api.forEachNodeAfterFilter((row) => { if (!row.group) { returnData.push(row.data) } })\r\n        break;\r\n\r\n      case 2: //FILTERED_SORTED_DATA\r\n        this.api.forEachNodeAfterFilterAndSort((row) => { if (!row.group) { returnData.push(row.data) } })\r\n        break;\r\n    }\r\n\r\n    let returnValue = {\r\n      originalDtypes: this.frameDtypes,\r\n      rowData: returnData,\r\n      selectedRows: this.api.getSelectedRows()\r\n    }\r\n\r\n    Streamlit.setComponentValue(returnValue)\r\n  }\r\n\r\n  private ManualUpdateButton(props: any) {\r\n    if (props.manual_update) {\r\n      return (<button onClick={props.onClick}>Update</button>)\r\n    }\r\n    else {\r\n      return (<span></span>)\r\n    }\r\n  }\r\n\r\n  private defineContainerHeight() {\r\n    if ('domLayout' in this.gridOptions) {\r\n      if (this.gridOptions['domLayout'] === 'autoHeight') {\r\n        return ({\r\n          width: this.props.width\r\n        })\r\n      }\r\n    }\r\n    return ({\r\n      width: this.props.width,\r\n      height: this.state.gridHeight\r\n    })\r\n  }\r\n\r\n  public render = (): ReactNode => {\r\n    let gridOptions = Object.assign({}, this.columnFormaters, this.gridOptions)\r\n\r\n    if (this.allowUnsafeJsCode) {\r\n      console.warn(\"flag allow_unsafe_jscode is on.\")\r\n      gridOptions = this.convertJavascriptCodeOnGridOptions(gridOptions)\r\n    }\r\n\r\n    return (\r\n      <div className=\"ag-theme-balham\" style={this.defineContainerHeight()}>\r\n        <this.ManualUpdateButton manual_update={this.manualUpdateRequested} onClick={(e: any) => this.returnGridValue(e)} />\r\n        <AgGridReact\r\n          onGridReady={(e) => this.onGridReady(e)}\r\n          gridOptions={gridOptions}\r\n          rowData={this.state.rowData}\r\n        >\r\n        </AgGridReact>\r\n      </div >\r\n    )\r\n  }\r\n}\r\n\r\n// \"withStreamlitConnection\" is a wrapper function. It bootstraps the\r\n// connection between your component and the Streamlit app, and handles\r\n// passing arguments from Python -> Component.\r\n//\r\n// You don't need to edit withStreamlitConnection (but you're welcome to!).\r\nexport default withStreamlitConnection(AgGrid)\r\n","import React from \"react\"\nimport ReactDOM from \"react-dom\"\nimport AgGrid from \"./AgGrid\"\n\nReactDOM.render(\n  <React.StrictMode>\n    <AgGrid />\n  </React.StrictMode>,\n  document.getElementById(\"root\")\n)\n"],"sourceRoot":""}