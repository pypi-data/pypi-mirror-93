<html>
<head>
<title>ASTVIEWER - a tool for exploring Starlink AST FrameSets</title>
<style>
pre {
    margin-left: 20px;
    font-family: monospace;
    font-weight: bold;
}
#toc_container {
    background: #f9f9f9 none repeat scroll 0 0;
    border: 1px solid #aaa;
    display: table;
    font-size: 95%;
    margin-bottom: 1em;
    padding: 20px;
    width: auto;
}

.toc_title {
    font-weight: 700;
    text-align: center;
}

#toc_container li, #toc_container ul, #toc_container ul li{
    list-style: outside none none !important;
}
</style>
</head>
<body>
<P><HR><P>
<h1><center>
ASTVIEWER - a tool for exploring Starlink AST FrameSets
</center></h1>
<P><HR><P>

<div id="toc_container">
<ul class="toc_list">
  <li><a href="#introduction">1 Introduction</a>
  <ul>
    <li><a href="#whatisastviewer">1.1 What is <code>astviewer</code>?</a></li>
    <li><a href="#dataformats">1.2 Data formats</a></li>
    <li><a href="#installation">1.3 Installation</a></li>
    <li><a href="#requirements">1.4 Requirements</a></li>
    <li><a href="#runningastviewer">1.5 Running and closing <code>astviewer</code></a></li>
  </ul>
  </li>
  <li><a href="#astviewer">2 The FrameSet viewer</a></li>
  <li><a href="#framewidget">3 The Frame viewer</a></li>
  <li><a href="#mappingwidget">4 The Mapping viewer</a></li>
</ul>
</div>
<h2 id="introduction">Introduction</h2>

<h3 id="whatisastviewer">What is <code>astviewer</code>?</h3>
The <code>astviewer</code> python script visualises the contents of a
<code>FrameSet</code> object created by the starlink AST library (see
<code>www.starlink.ac.uk/ast</code>). It allows you to:
<ol>
<li> Read a FrameSet from various sorts of file including text files,
Starlink NDFs and FITS files. See <a href="#dataformats">'Data formats'</a>.
<li> See a graphical representation of the coordinate Frames contained in
the FrameSet and the Mappings that describe the transformations that
connect them. See <a href="#astviewer">'The FrameSet viewer'</a>.
<li>Examine the details of any Frame or Mapping, including individual AST
attribute values as well as a more human-readable summary. See <a
href="#framewidget">'The Frame viewer'</a> and
<a href="#mappingwidget">'The Mapping viewer'</a>.
<li>Save individual Frames or Mappings to new text files
<li>Transform positions between any two Frames or using any Mapping, seeing
the results of any intermediate Mappings that may make up the total Mapping.
<li>Convert numerical axis values into their `formatted` representation
(e.g. convert <emph>Declination</emph> values from radians to sexagesimal
format).
<li>Convert formatted axis values in to the corresponding numerical values
(e.g. convert <emph>Declination</emph> values from sexagesimal format to
radians).
<li> Explore the effects of Simplifying a Mapping or FrameSet.
<li> Explore the effects of changing FrameSet attribute values.
</ol>
<p>
Below is an example of how a FrameSet is displayed. This is the
demonstration FrameSet that is displayed if no <code>astviewer</code> is
started without specifying an input file on the command line:
<p><center><img src="example-frameset.png" width="800" id="example"></center>

<h3 id="dataformats">Data formats</h3>
FrameSets can be read in any of the following forms:
<ol>
<li> From a text file containing a description of the FrameSet in 'raw AST'
format. This is the format generated by the <code>astShow</code>
method within AST. It is also the format used by the Starlink ATOOLS
package. The text file may contain the dump of a FrameSet, a Mapping, or
a Frame. However, if a Mapping or Frame is supplied, the main
<code>astviewer</code>
window  that normally displays the FrameSet will remain blank, and the
Mapping or Frame will be displayed in a pop-up dialog.
<li> From a text file containing a set of FITS-WCS headers.
<li> From a FITS file containing an image in the primary HDU. The FrameSet
read describes the WCS information in the FITS headers.
<li> From a Starlink NDF data structure. The FrameSet read describes the
WCS component of the NDF.
</ol>
Objects are always saved in the first ('raw AST)') format.

<h3>Installation</h3>
<code>astviewer</code> is included in the Starlink ATOOLS package, which
is part of the Starlink Software Collection (see <code>www.starlink.ac.uk</code>).
<p>
It can also be obtained from <code>pypi.org</code> - search for project
'astviewer'. To install it, do:
<pre>
% pip install starlink-astviewer
</pre>

<h3 id="requirements">Requirements</h3>
Running <code>astviewer</code> requires the following packages to be
installed:
<ul>
<li>Python 2.7 or later (including Python 3).
<li>The <code>pyqt5</code> library. This is usually included in Linux
distributions, but can be installed separately if required. See <code>
http://pyqt.sourceforge.net/Docs/PyQt5/installation.html</code>.
<li>The Starlink <code>pyast</code> package - a Python interface to AST.
This can be installed from <code>pypi.org</code> by doing:
<pre>
% pip install starlink-pyast
</pre>
Documentation is available at <code>timj.github.io/starlink-pyast/pyast.html</code>.
Note, pyast version 3.11 or later is required for full functionality.
<li>In order to read FrameSets from Starlink NDF structures, the Starlink
Software Collection (SSC) must be available, and pointed to by the environment
variable <code>STARLINK\_DIR</code>. If the SSC is not available,
<code>astviewer</code> will still run but will not be able to read FrameSets from NDFs.
<li>In order to read FrameSets from FITS files, the <code>io.fits</code>
module within <code>astropy</code> (see <code>www.astropy.org</code>)
must be available. If the <code>astropy.io.fits</code> is not available,
<code>astviewer</code> will still run but will not be able to read FrameSets from FITS
files.
</ul>

<h3 id="runningastviewer">Running and closing <code>astviewer</code></h3>
If you have the Starlink Software Collection installed, you can run
<code>astviewer</code> as follows:
<pre>
% atools
% astviewer <file>
</pre>
<p>
If you have installed <code>astviewer</code> from <code>www.pypi</code>
you need to determine where the script has been installed. If you ran
<code>pip install</code> with the <code>--user</code> option, it will
probably be in <code>$HOME/.local/bin</code>, so for convenience you
should either add this directory to your PATH or define an alias to run
<code>astviewer</code>. It can then be run as:
<pre>
% astviewer <file>
</pre>
<p>
In either case, if an input file is specified on the command line a
FrameSet will be read from the file and displayed. If no input file is
specified, an example FrameSet will be generated and displayed
automatically. To replace this example FrameSet, use the <code>Open</code>
option in the <code>File</code> menu to read a FrameSet from a selected
file (see <a href="#dataformats">'Data formats'</a>). In either case, the
FrameSet can be explored as described in <a href="#astviewer">'The
FrameSet viewer'</a>.
<p>
To close down <code>astviewer</code>, use the <code>Close</code> item in
the  <code>File</code> menu on the main window, or press Control+Q.

<h2 id="astviewer">The FrameSet viewer</h2>

When a FrameSet is opened, a graphical representation of the Frames and
Mappings within the FrameSet is displayed. An example is shown below:
<p><center><img src="makecube.png"></center>

(also see the <a href="#example">earlier example</a>).
<p>
<B>Frames:</b>
Each box represents a coordinate Frame, and displays its main properties:
<ul>
<li> An integer index, starting at 1, that identifies the Frame within
the FrameSet.
<li> A domain name, describing the physical domain that the Frame
represents.
<li>An indication of whether the Frame is used as the <i>base</i> or
<i>current</i> Frame within the FrameSet. The base and current frames are
also highlighted by a blue border.
</ul>
Clicking on (without also dragging) a Frame will create a pop-up window
containing more extensive details of the Frame - see
<a href="#framewidget">Viewing the details of a Frame</a>. Details of the current
Frame can be viewed by pressing <code>ctrl-C</code, and details of the
base Frame  can be viewed by pressing <code>ctrl-B</code>.
<p>
Clicking and dragging a Frame will move the Frame icon, together with any
connected Mappings and <i>child frames</i> (i.e. any Frames reached by
out-going arrows from the selected Frame).
<p>
Clicking on a Frame whilst the <code>control</code> key is pressed and
then dragging will draw out a red dotted arrow. If the mouse button is
then released with the pointer over another Frame, the Mapping between
the two Frames will be displayed in a pop-window - see <a href="#mappingwidget">
Viewing the details of a Mapping</a>.

<p>
<b>Mappings:</b>
Each arrow represents a Mapping, containing two <i>transformations</i> -
the <i>forward</i> transformation of a Mapping transforms positions in the direction
of the arrow, the <i>inverse</i> transformation transforms positions in
the opposite direction. Each end of a Mapping can be connected to a Frame
(a box) or a Node (a black dot). A Node can be thought of as an
anonymous intermediate coordinate system for which no metadata has been stored.
<p>
Clicking on a Mapping arrow will create a pop-up window containing more extensive
details of the Mapping - see
<a href="#mappingwidget">Viewing the details of a Mapping</a>. Details of
the Mapping from the base Frame to the current Frame can be viewed by pressing
<code>ctrl-M</code>.
<p>
The Mapping between any pair of Frames can be seen by clicking and
dragging between the Frames, with the <code>control</code> key pressed.
<p>
<b>The <code>File</code> menu:</b> contains the following:
<ul>
<li><i>Open</i> - Read a new FrameSet from a file. A new tab is created
containing the FrameSet.
<li><i>Close</i> - Close the current tab.
<li><i>Preferences</i> - Change global preferences that control how
<code>astviewer</code> behaves. Currently, the only option that can be
set is the <code>FitsChan</code> attribute settings to be used when
reading a FrameSet from a FITS file or text file containing FITS headers.
<li><i>Exit</i> - Close all tabs and exit the application.
</ul>

<p>
<b>The <code>Actions</code> menu:</b> provides the following actions that
be applied to the displayed FrameSet:
<ul>
<li><i>Get/Clear attributes</i> - Allows the value of any FrameSet
attribute to to be displayed or cleared. Enter an attribute name into the
text box, and then press the <code>Get</code> button to display the
current value of the attribute. Whether this is the default value, or a
value that has been set explicitly will be indicated by the string
'(default)' or '(set)' appended to the end of the attribute value.
Alternatively, press the <code>Clear</code> button to
first clear the attribute and then display the default value of the
attribute. Pressing the <code>Return</code> key in the text box is like
pressing the <code>Get</code> button.

<li><i>Set Attributes</i> - Allows new values to be assigned to one or
more FrameSet attributes. The modified FrameSet will be displayed in a
new tab.
<li><i>View Base Frame</i> - Display a pop-up window containing
details of the Base Frame.
<li><i>View Current Frame</i> - Display a pop-up window containing
details of the Current Frame.
<li><i>View Base->Current Mapping</i> - Display a pop-up window containing
details of the Mapping from the Base Frame to the Current Frame.
<li><i>Simplify FrameSet</i> - Applies the <code>astSimplify</code>
method to the FrameSet. The simplified FrameSet is displayed in a new tab.
</ul>

<h2 id="framewidget">Viewing the details of a Frame</h2>
To see details of a Frame, click on the box representing the Frame in the
FrameSet, or use one of the keyboard shortcuts listed in the FrameSet
<code>Actions</code> menu. An example SkyFrame is  shown below:
<p><center><img src="frame.png"></center><p>
<b>Viewing the raw AST data:</B> Click on the "Raw AST data" tab to see a
full description of the Frame in the form created by the AST
<code>astDump</code> method.<p>
<b>Axis descriptions:</B> The "Axis descriptions" tab contains a
human-friendly summary of the main details of the Frame. First the
properties of each individual axis are listed, followed by properties of
the celestial, spectral or time coordinate systems to which the axes
relate.<p>
<b>Formatting and unformatting axis values:</b> Some classes of Frame
format numerical axis values in a specic way. For instance, the SkyFrame
class uses numerical longitude and latitude values in units of radians
internally, but can formatted them as (for instance) sexagesimal strings
for human readers. The TimeFrame class can similarly format axis values as
ISO date strings. Entering a numerical value into an "Unformatted" text
box and then pressing return (or shifting focus to another box) will
cause the corresponding formatted string to appear in the "Formatted"
text box. Likewise, entering a formatted string into a "Formatted" text
box and then pressing return (or shifting focus to another box) will
cause the corresponding numerical value to appear in the "Unformatted"
text box.<p>
<b>The <code>File</code> menu: </b> allows the Frame to be saved to a
text file in AST "raw" format.<p>
<b>The <code>Actions</code> menu: </b> allows Frame attribute values to
be displayed, cleared or changed. Note, any changes made to the
attributes of the Frame will be lost when the Frame pop-up window is
closed.<p>
<b>The <code>Back</code> button:</b> is disabled unless the Frame details
were displayed as a result of clicking on a link within a previously
displayed Mapping (see <a href="#mappingwidget">Viewing the details of a
Mapping</a>). If clicked, the Frame details will be replaced by the
details of the previously displayed Mapping.<p>
<b>The <code>Send</code> button:</b> performs the same function as the
<code>Back</code> button, except that any unformatted axis values
currently visible in the Frame's "Unformatted" text boxes are <i>sent</i>
to the Mapping and will appear in the appropriate places when the Mapping
details are displayed.<p>

<h2 id="mappingwidget">Viewing the details of a Mapping</h2>
To see details of a Mapping, click on the arrow representing the Mapping
in the FrameSet, or use one of the keyboard shortcuts listed in the
FrameSet <code>Actions</code> menu. An example Mapping (a compound
Mapping - or <code>CmpMap</code> - made up of several ataomic Mappings in
series) is shown below: <p><center><img src="mapping.png"></center><p>

<b>Viewing the raw AST data:</B> Click on the "Raw AST data" tab to see a
full description of the Mapping in the form created by the AST
<code>astDump</code> method.<p>
<b>Component Mappings:</B> If the Mapping is a compound Mapping made up
of other Mappings in series or parallel, a tab labelled "Component Mappings"
will be visible, and will show the component Mappings expanded into a
vertical list that are applied in series or in parallel. Each component Mapping
will be represented by a button that can be clicked to see details of the
corresponding invididual Mapping. There will also be a set of text boxes
into which numerical axis values can be entered (the string "BAD" can also be
entered). <p>

For a <b>series CmpMap</b>, the forward transformation of the compound
Mapping will proceeed from the top of the list to the bottom. There will
be a row of text boxes to the
right of the Mapping's button, displaying the Mapping's output axis
values. There will also be an initial row of text boxes, displaying the
axis values supplied as input to the first Mapping in the series. New
values can be entered into any of these boxes - pressing the
<code>Return</code> key (or shifting focus to another box) will cause the
new values to be transformed to re-populate all the other boxes. If new
input values are supplied for the initial component Mappings, the forward
transformation of each Mapping will be used to generate the new values.
If new output values are supplied for the final component Mappings, the
inverse transformation of each Mapping will be used to generate the new values.
If new output values are supplied for an intermediate Mapping, the
forward transformation of subsequent Mappings will be used to generate
later values, and the inverse transformation of earlier Mappings will be
used to generate earlier values. The direction of the transformation used
for each Mapping is indicated by a small vertical arrow to the right of
the Mapping's button (the Mapping for which new output values were
entered will have no arrow, indicating that the user enterd the values).
The tool tips associated with these arrows give more detail.<p>

For a <b>parallel CmpMap</b>, the forward transformation of the compound
Mapping will proceeed from the left to the right. Component Mappings that
transform lower numbered axes will be at the bottom of the vertical list
of Mappings, and axis number will increase verically upwards. See the
example below: <p><center><img src="parallel.png"></center><p>
Again, entering numerical axis values into any text box and pressing
<code>Return</code> will cause the other text boxes to be populated with
the corresponding values generated by the appropriate transformations.
The arrow at the middle of the top row indicates the direction of te
transformation that was last used.<p>

<b>Atomic Mappings</b>,(i.e. Mappings that are not made up of other
Mappings) will be displayed in the style of a parallel CmpMap, but the
Mapping button will be replaced by a simple label indicating ther class
of the atomic Mapping.<p>

<b>The <code>Back</code> button:</b> is disabled unless the Mapping details
were displayed as a result of clicking on a Mapping button within a previously
displayed Mapping. If clicked, the currently visible Mapping details will be
replaced by the details of the previously displayed Mapping.<p>

<b>The <code>Send</code> button:</b> performs the same function as the
<code>Back</code> button, except that the currently visible output axis values
are <i>sent</i> back to the previous Mapping and will appear in the appropriate
places when the Mapping details are displayed (new values for all other
text boxes will be regenerated on the basis of the sent axis values).<p>

<b>Frame information</b> describing the inputs or outputs of individual
Mapping may be available if the Mapping inputs or outputs correspond to
one of the Frames in the displayed FrameSet. In such cases, the Mappings
dialog will contain blue hyperlinks that can be clicked to see
corresponding Frame information, as described <a href="#framewidget">above</a>.
The text of these links will be either "inputs", "outputs", or the symbol
associated with a specific Frame axis.


</body>
</html>
