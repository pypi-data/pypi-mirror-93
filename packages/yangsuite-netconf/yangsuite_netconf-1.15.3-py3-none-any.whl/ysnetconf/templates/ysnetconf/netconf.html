{% extends 'yangsuite/base-cui.html' %}
{% load staticfiles %}
{% block javascript %}
<script src="{% static 'yangsuite/js/formatXML.js' %}"></script>
<script src="{% static 'ysdevices/js/devices.js' %}"></script>
<script src="{% static 'ysfilemanager/js/yangsets.js' %}"></script>
<script src="{% static 'ysyangtree/js/yangtree.js' %}"></script>
<script src="{% static 'ysyangtree/js/rpc_ui.js' %}"></script>
<script src="{% static 'ysyangtree/js/chosen/chosen.jquery.js' %}"></script>
<script src="{% static 'ysyangtree/js/jstreegrid.js' %}"></script>
<script src="{% static 'ysnetconf/js/netconf.js' %}"></script>
<script src="{% static 'ysnetconf/js/rpcmanager.js' %}"></script>
<script src="{% static 'ysyangtree/js/tasks.js' %}"></script>
<script defer src="{% static 'yangsuite/js/fontawesome-all.js' %}"></script>
{% endblock javascript %}
{% block cui-css %}
<link rel="stylesheet" href="{% static 'yangsuite/css/cui-standard-1.3.3.min.css' %}"/>
{% endblock %}
{% block css %}
<link rel="stylesheet" href="{% static 'ysdevices/css/device.css' %}"/>
<link rel="stylesheet" href="{% static 'ysyangtree/css/chosen/chosen.css' %}"/>
<link rel="stylesheet" href="{% static 'ysyangtree/css/chosen-cui.css' %}"/>
<link rel="stylesheet" href="{% static 'ysyangtree/css/yangtree.css' %}"/>
<link rel="stylesheet" href="{% static 'ysnetconf/css/netconf.css' %}"/>
{% endblock css %}
{% block page-title %}NETCONF{% endblock %}
{% block help_url %}{% url 'help' section='ysnetconf' %}{% endblock %}
{% block body %}
{% csrf_token %}
<div class="container-fluid">
  <div class="row">
    <div class="col-5">
      <div class="form-group label--inline">
        <div class="form-group__text select">
          <label for="ytool-yangset">YANG Set</label>
          <select id="ytool-yangset"></select>
        </div>
      </div>
    </div>
    <div class="col">
      <form id="ys-module-select" class="ys-yangset-required">
        <div class="form-group label--inline">
          <div class="form-group__text select">
            <label for="ytool-models">Module(s)</label>
            <select id="ytool-models" multiple=""
                    data-placeholder="Type here to filter available modules">
            </select>
          </div>
        </div>
      </form>
    </div>
    <div class="col-auto flex-center-vertical">
      <input id="ys-load-modules" type="submit" value="Load Module(s)" form="ys-module-select"
             class="btn btn--primary btn--small ys-yangset-required">
    </div>
  </div>

  <div class="row">
    <div class="col-auto">
      <div class="ys-module-required form-group label--inline">
        <div class="form-group__text select">
          <label for="ys-proto-op">NETCONF Operation&nbsp;</label>
          <select id="ys-proto-op">
            <option value="get-config" id="netconf-op-get-config">get-config</option>
            <option value="edit-config" id="netconf-op-edit-config">edit-config</option>
            <option value="get" id="netconf-op-get">get</option>
            <option value="action" id="netconf-op-action">action</option>
            <option value="rpc" id="netconf-op-rpc">(other RPC)</option>
          </select>
        </div>
      </div>
    </div>
    <div class="col-auto">
      <div class="form-group label--inline">
        <div class="form-group__text select">
          <!-- tasks.js is hardcoded to look for "ys-devices-replay" by ID -->
          <label for="ys-devices-replay">Device</label>
          <select id="ys-devices-replay" class="ys-devices">
            <option value="" selected>(none selected)</option>
            {% for device in devices %}
            <option value="{{ device.key }}" title="{{ device.description }}">{{ device.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
    <div class="col-auto flex-center-vertical">
      <button id="ys-edit-device" class="btn btn--secondary btn--small disabled">
        <span class="fas fa-fw fa-lg fa-cog"></span>
        Edit Device
      </button>
      <div class="form-group label--inline">
        <div class="form-group__text select">
            <select id="ys-open-device-window" class="disabled">
                <option value="none">Open Device Window</option>
                <option value="pop">Open in new window</option>
                <option value="tab">Open in new tab</option>
            </select>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-6">
      <div class="dropdown">
        <button class="btn btn--small btn--dropdown">
          <span class="fas fa-fw fa-lg fa-tree"></span> YANG Tree</button>
        <div class="dropdown__menu">
          <a id="ys-search-xpaths-menu-item" class="ys-module-required">
            <span class="fas fa-fw fa-lg fa-search"></span> Search XPaths&hellip;
          </a>
          <a id="ys-legend-menu-item">
            <span class="fas fa-fw fa-lg fa-list"></span> Show Legend
          </a>
          <a id="ys-options-menu-item">
            <span class="fas fa-fw fa-lg fa-cogs"></span> Options&hellip;
          </a>
          <a id="ys-clear-grid-menu-item">
            <span class="fas fa-fw fa-lg fa-ban"></span> Clear Values and Operations
          </a>
        </div>
      </div>
      <div class="dropdown">
        <button class="btn btn--small btn--dropdown">
          <span class="fas fa-fw fa-lg fa-redo"></span>Replays</button>
        <div class="dropdown__menu">
          <a id="ys-load-replay-menu-item">
            <span class="fas fa-fw fa-lg fa-upload"></span> Load Replay&hellip;
          </a>
          <a id="ys-save-as-replay-menu-item">
            <span class="fas fa-fw fa-lg fa-download"></span> Save as New Replay&hellip;
          </a>
          <a id="ys-edit-replay-menu-item" class="ys-replay-required disabled">
            <span class="fas fa-fw fa-lg fa-edit"></span> Edit Replay Information&hellip;
          </a>
          <a id="ys-save-replay-menu-item" class="ys-replay-required disabled">
            <span class="far fa-fw fa-lg fa-save"></span> Save Changes
          </a>
          <a id="ys-generate-python-menu-item">
            <span class="fab fa-fw fa-lg fa-python"></span>Generate Python script</a>
        </div>
      </div>
      <button id="ys-rpc-options-btn" class="btn btn--small btn--secondary">
        RPC Options&hellip;
      </button>
      <button id="ys-build-rpc-btn" class="btn btn--small btn--primary">
          <span class="fas fa-fw fa-lg fa-code"></span> Build RPC
      </button>
    </div>
    <div class="col">
      <button id="ys-run-rpcs-btn" class="btn btn--small btn--primary">
        <span class="fas fa-fw fa-lg fa-play-circle"></span> Run RPC(s)
      </button>
      <span class="pull-right">
        <button id="ys-clear-rpcs-btn" class="btn btn--small btn--negative">
          <span class="fas fa-fw fa-lg fa-ban"></span> Clear RPC(s)
        </button>
      </span>
    </div>
  </div>

</div>



<div class="content" style="height: calc(100% - 183px)">
  <div class="container-fluid" style="height:100%">
    <div class="row" style="height:100%">
      <div class="col-6 flex-center-vertical" style="height:100%; overflow:auto">
        <div id="tree"></div>
      </div>
      <div class="col flex-center-vertical" style="height:100%; overflow:auto">
        <textarea id="ytool-rpc-data" wrap="soft" style="width:100%; height:calc(100% - 6px)"></textarea>
      </div>
    </div>
  </div>
</div>



<div id="ys-icon-dialog" hidden>
  <table id="ysyangtree-legend" class="table table--compressed"></table>
</div>

<div id="ys-nc-options-dialog" hidden>
  <div class="row">
    <div class="col">
      <div class="form-group label--inline input--compressed">
        <div class="form-group__text">
          <label for="ys-replay-dir">Replay Directory:</label>
          <input id="ys-replay-dir" value="{{replay_dir}}" type="text"/>
        </div>
      </div>
    </div>
    <div class="col-auto">
      <button id="ys-replay-dir-btn" class="btn btn--small">Set</button>
      <button id="ys-reset-replay-dir-btn" class="btn btn--small">Reset</button>
    </div>
  </div>
  <div class="row">
    <div class="col flex-center-vertical">
      <label>Tree nodes not usable with selected operation:&nbsp;</label>
      <div class="form-group form-group--inline">
        <label class="radio radio--alt">
          <input type="radio" name="hide-nodes" value="disable" checked>
          <span class="radio__input"></span>
          <span class="radio__label">Visible but disabled</span>
        </label>
      </div>
      <div class="form-group form-group--inline">
        <label class="radio radio--alt">
          <input type="radio" name="hide-nodes" value="hide">
          <span class="radio__input"></span>
          <span class="radio__label">Hidden</span>
        </label>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col">
      <div class="form-group label--inline">
        <div class="form-group__text select">
          <label for="ys-rpctype">Display RPC(s) as &nbsp;</label>
          <select id="ys-rpctype">
            <option value="raw" selected="">NETCONF RPC XML</option>
            <option value="basic">NETCONF XML (RPC parameters only)</option>
          </select>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col flex-center-vertical">
      <label>Use XML namespace prefixes:&nbsp;</label>
      <div class="form-group form-group--inline">
        <label class="radio radio--alt">
          <input type="radio" name="ys-rpcprefixes" value="minimal" checked>
          <span class="radio__input"></span>
          <span class="radio__label">Only when required</span>
        </label>
      </div>
      <div class="form-group form-group--inline">
        <label class="radio radio--alt">
          <input type="radio" name="ys-rpcprefixes" value="always">
          <span class="radio__input"></span>
          <span class="radio__label">Always, for all namespaces</span>
        </label>
      </div>
    </div>
    <!-- TODO: 'Declare prefixes: (x) on root element ( ) where introduced' -->
  </div>
  <div class="row">
    <div class="col">
      <div class="form-group label--inline">
        <label class="checkbox">
          <input type="checkbox" id="ys-logging">
          <span class="checkbox__input"></span>
          <span class="checkbox__label">Enable NETCONF debug logging</span>
        </label>
      </div>
    </div>
  </div>
</div>

<div id="ys-build-get-config-dialog" hidden>
  <input type="hidden" autofocus="autofocus" />
  <div>
    <label>Datastore</label>
    <div class="btn-group" data-toggle="buttons" role="group"
         id="ys-gc-datastore-group"
         aria-label="Datastore:">
      <button class="btn btn--small btn--primary-ghost datastore-candidate"
              data-value="candidate" id="gc-datastore-candidate">
        candidate
      </button>
      <button class="btn btn--small btn--primary-ghost datastore-running selected"
              data-value="running" id="gc-datastore-running">
        running
      </button>
      <button class="btn btn--small btn--primary-ghost datastore-startup"
              data-value="startup" id="gc-datastore-startup">
        startup
      </button>
    </div>
  </div>
  <div class="form-group label--inline">
    <div class="form-group__text select">
      <label for="ys-gc-with-defaults">With-Defaults
        (<a href="https://tools.ietf.org/html/rfc6243">RFC 6243</a>, optional)</label>
      <select id="ys-gc-with-defaults">
        <option value="">(Don't specify a with-defaults value)</option>
        <option value="report-all">Report-all &mdash; include all default values</option>
        <option value="trim">Trim &mdash; do not report default values</option>
        <option value="explicit">Explicit &mdash; only report default values if explicitly set</option>
        <option value="report-all-tagged">Report-all-tagged &mdash; tag default values as such</option>
      </select>
    </div>
  </div>
</div>

<div id="ys-build-edit-config-dialog" hidden>
  <input type="hidden" autofocus="autofocus" />
  <div>
    <label>Datastore</label>
    <div class="btn-group" data-toggle="buttons" role="group"
         id="ys-ec-datastore-group"
         aria-label="Datastore:">
      <button class="btn btn--small btn--primary-ghost datastore-candidate"
              data-value="candidate" id="ec-datastore-candidate">
        candidate
      </button>
      <button class="btn btn--small btn--primary-ghost datastore-running selected"
              data-value="running" id="ec-datastore-running">
        running
      </button>
      <!-- edit-config cannot apply to startup-config -->
    </div>
  </div>
  <div>
    <span class="icon-warning icon-small"></span>
    An <q>edit-config</q> to the <q>candidate</q> datastore
    will not take effect unless followed by a <q>commit</q>.
  </div>
  <div class="form-group">
    <label class="checkbox">
      <input type="checkbox" id="ys-ec-add-commit">
      <span class="checkbox__input"></span>
      <span class="checkbox__label">Add <q>commit</q> RPC after editing candidate datastore</span>
    </label>
  </div>
  <!-- "default-operation" option would go here -->
</div>

<div id="ys-build-get-dialog" hidden>
  <div class="form-group label--inline">
    <div class="form-group__text select">
      <label for="ys-get-with-defaults">With-Defaults
        (<a href="https://tools.ietf.org/html/rfc6243">RFC 6243</a>, optional)</label>
      <select id="ys-get-with-defaults">
        <option value="">(Don't specify a with-defaults value)</option>
        <option value="report-all">Report-all &mdash; include all default values</option>
        <option value="trim">Trim &mdash; do not report default values</option>
        <option value="explicit">Explicit &mdash; only report default values if explicitly set</option>
        <option value="report-all-tagged">Report-all-tagged &mdash; tag default values as such</option>
      </select>
    </div>
  </div>
</div>

<div id="ys-build-action-dialog" hidden>

</div>

<div id="ys-build-rpc-dialog" hidden>

</div>

<div id="ys-load-replay-dialog" hidden>
  <div class="form-group">
    <div class="form-group__text select">
      <label for="ys-replay-cat-list">Replay Category</label>
      <select id="ys-replay-cat-list"></select>
    </div>
  </div>
  <div class="form-group">
    <div class="form-group__text select">
      <label for="ytool-task-list">Replay Name</label>
      <select id="ytool-task-list"></select>
    </div>
  </div>
  <div class="form-group label--inline">
    <div class="form-group__text">
      <label>Datastore</label>
      <div class="btn-group" data-toggle="buttons" role="group"
           id="ys-replay-datastore-group"
           aria-label="Datastore:">
        <button class="btn btn--small btn--primary-ghost"
                data-value="candidate" id="replay-datastore-candidate">
          candidate
        </button>
        <button class="btn btn--small btn--primary-ghost selected"
                data-value="running" id="replay-datastore-running">
          running
        </button>
        <button class="btn btn--small btn--primary-ghost"
                data-value="startup" id="replay-datastore-startup">
          startup
        </button>
      </div>
    </div>
  </div>
  <div>
    <label>Variables and Values</label>
    <div>
      <form-group id="ys-variables"></form-group>
    </div>
    <div>
      <button id="ys-save-variables" class="btn btn--small"
              title="Save variables and their values to the selected device profile">
        Save Variables to Device</button>
    </div>
  </div>
</div>

<div id="ys-task-dialog" title="Yang Suite"></div>
<div id="ys-run-dialog" title="RPC Run"></div>
<div id="ytool-clear-dialog" title="Clear RPC Run?"></div>
<div id="ys-save-task"></div>
<div id="ys-bits-dialog"></div>
<div id="ys-anyxml-dialog">
  <textarea id="ys-anyxml-text" placeholder="XML string" cols="80" rows="24">
  </textarea>
</div>
<div id="ys-device-dialog"></div>
{% include "ysyangtree/search_xpaths_dialog.html" %}
{% endblock body %}
{% block script %}
<script>
$(function() {

    let contextMenuHovered = false;
    $("#ys-task-dialog").dialog({autoOpen: false});
    $("#ys-run-dialog").dialog({autoOpen: false});
    $("#ytool-clear-dialog").dialog({autoOpen: false});
    $("#ys-anyxml-dialog").dialog({autoOpen: false});
    $("#ys-lockunlock-dialog").dialog({autoOpen: false});
    $("#ytool-models").chosen({width: "calc(100% - 8rem)"});
    $(".ys-yangset-required").addClass("disabled");
    $(".ys-module-required").addClass("disabled");

    yangsets.config.progress = 'div#ys-progress';
    yangsets.config.yangsetsSelect = 'select#ytool-yangset';

    yangtree.config.exploreStateURI = "/netconf/getyang/";
    yangtree.config.exploreStateTitle = 'NETCONF';
    yangtree.config.initialModuleSelection = "{{ modulenames }}".split(',');

    rpc_ui.config.getProtocolOperation = netconf.getProtocolOperation;
    rpc_ui.config.buildEditProtocolOperationMenu = netconf.buildEditProtocolOperationMenu;

    yangtree.buildLegend($("#ysyangtree-legend"));

    yangsets.getYangSets("{{ yangset }}");

    tasks.getTasks().then(function() {
        $("#ys-replay-cat-list").chosen({width: "100%"});
        $("#ytool-task-list").chosen({width: "100%"});
        $("#ys-replay-cat-list").trigger('change');
    });
    netconf.getDatastores();
    tasks.replayVariables('add');

    $(document).click(function (event) {
      if (!contextMenuHovered) {
          $(".dropdown").removeClass("active");
      }
    });

    $(".dropdown").mouseenter(function(e) {
      contextMenuHovered = true;
    });

    $(".dropdown").mouseleave(function(e) {
      contextMenuHovered = false;
    });

    /***************************
     * General UI elements
     ***************************/

    $("#ytool-yangset").change(function(e) {
        $.jstree.destroy($("#tree"));

        $("#ytool-models").empty();
        $(".ys-module-required").addClass("disabled");

        if ($("#ytool-yangset").val() == "") {
            $(".ys-yangset-required").addClass("disabled");
            return;
        }
        tasks.config.taskYangset = $("#ytool-yangset").val();
        yangtree.getModels($("#ytool-yangset").val(), $("#ytool-models"))
            .done(function() {
                yangtree.pushExploreState($("#ytool-yangset").val(),
                                          $("#ytool-models").val());
                $("#ytool-models").trigger("chosen:updated");
                $(".ys-yangset-required").removeClass("disabled");
                /*
                 * If we preselected a module(s) through
                 * yangtree.config.initialModuleSelection,
                 * load the module(s) now.
                 */
                if ($("#ytool-models").val()) {
                    $("#ys-module-select").trigger("submit");
                }
            });
    });

    $("#ys-module-select").submit(function (e) {
        e.preventDefault();
        e.stopPropagation();
        var names = $("#ytool-models").val();

        if (names) {
            $(".ys-module-required").removeClass("disabled");
            netconf.jsTree(["yang"], names, $("#ytool-yangset").val()).then(function() {
                rpc_ui.changeTree($("#tree"));
                if (!$("#ytool-rpc-data").hasClass("source-of-truth")) {
                    $(".jstree-grid-wrapper").addClass("source-of-truth");
                }
            });
        } else if ($("#tree").jstree(true)) {
            $.jstree.destroy($("#tree"));
        }
        yangtree.pushExploreState($("#ytool-yangset").val(), names);
    });

    $("#ys-proto-op").change(function() {
        let protoOp = $(this).val();
        rpc_ui.refreshGrid((protoOp == 'get' || protoOp == 'action'),
                           (protoOp == 'get' || protoOp == 'get-config'));
        netconf.filterNodes();

        if (protoOp == 'action' ||  protoOp == 'rpc') {
          $("#ys-rpc-options-btn").addClass("disabled");
        }
        else {
          $("#ys-rpc-options-btn").removeClass("disabled");
        }

        if (protoOp == 'edit-config') {
          $("#tree").jstree(true).grid_show_column(2);
        }
        else {
          $("#tree").jstree(true).grid_hide_column(2);
        }
    });

    $(".btn--dropdown").click(function() {
      $(".dropdown").removeClass("active");
      $(this).parent().toggleClass("active");
    });

    function updateVariablesAndValues() {
        let oldVariables = tasks.replayVariables("retrieve");
        let variables = {};
        if ($("#ys-devices-replay").val()) {
            // Get the variables the selected device defines
            devices.getDevice($("#ys-devices-replay").val())
                .then(function(devObj) {
                    // Get the variables the selected replay requires
                    $.get(tasks.config.getVarsURI,
                          {name: $("#ytool-task-list").val(),
                           category: $("#ys-replay-cat-list").val()})
                        .then(function(retObj) {
                            for (let v of retObj.variables) {
                                variables[v] = devObj.device.base.variables[v] || oldVariables[v] || "";
                            }
                            tasks.replayVariablesPopulate(variables);
                        })
                });
        } else {
            // Get the variables the selected replay requires
            $.get(tasks.config.getVarsURI,
                  {name: $("#ytool-task-list").val(),
                   category: $("#ys-replay-cat-list").val()})
                .then(function(retObj) {
                    for (let v of retObj.variables) {
                        variables[v] = oldVariables[v] || "";
                    }
                    tasks.replayVariablesPopulate(variables);
                })
        }
    };

    $("#ys-devices-replay").change(function() {
        let device = $("#ys-devices-replay");
        if (device.val()) {
            $("#ys-edit-device").removeClass("disabled");
            $("#ys-open-device-window").removeClass("disabled");
        } else {
            $("#ys-edit-device").addClass("disabled");
            $("#ys-open-device-window").addClass("disabled");
        }
        updateVariablesAndValues();
        netconf.config.selectedDeviceChanged = true;
        netconf.getDatastores();

        if (!device.val()) {
          for (let dsstore of ['candidate', 'startup', 'running']) {
              let btn = $("#replay-datastore-" + dsstore);
              btn.removeClass("disabled");
          }
        }
        else {
          netconf.getAllDatastores(device.val()).then(function(retObj) {
            for (let dsstore of ['candidate', 'startup', 'running']) {
              let btn = $("#replay-datastore-" + dsstore);
              if (retObj['all_datastores'].includes(dsstore)) {
                btn.removeClass("disabled");
              }
              else {
                btn.addClass("disabled");
              }
            }
          });
        }
    });

    $("#ytool-task-list").change(updateVariablesAndValues);
    $("#ys-replay-cat-list").change(function() {
      tasks.getTaskList(category=$("#ys-replay-cat-list").val()).then(function(retObj) {
        let tasksList = retObj['tasks'];
        if (tasksList.length != 0) {
          $("#ytool-task-list").val(tasksList[0][0]);
          $("#ytool-task-list").trigger('change');
        }
      });
    });

    $("#ys-edit-device").click(function() {
        let device = $("#ys-devices-replay").val();
        netconf.startEndSession(device, 'end');
        devices.editDeviceDialog($("#ys-devices-replay").val());
    });

    $("#ys-open-device-window").change(function() {
        let device = $("#ys-devices-replay").val();
        let windowOrTab = $("#ys-open-device-window").val();
        rpcmanager.openDeviceWindow(device, 1500, windowOrTab);
    });

    /***************************
     * "YANG Tree" menu
     ***************************/

    // "Search XPaths..."

    $("#ys-search-xpaths-menu-item").click(function() {
        $(".dropdown").removeClass("active");
        $("#ys-search-xpaths-dialog").dialog({
            title: "Searching YANG node XPaths",
            width: 600,
            maxHeight: $(window).height() * 0.9,
            buttons: {
                "Show selected node(s)": function() {
                    $(this).dialog("close");
                    yangtree.selectNodes($("#ys-xpath-search-results").val());
                },
            },
        }).dialog("open");
    });

    $("#ys-xpath-search-form").submit(yangtree.searchXpathsFormSubmit);

    // "Legend"

    $("#ys-legend-menu-item").click(function() {
        $(".dropdown").removeClass("active");
        $("#ys-icon-dialog").dialog({
            title: "Tree Icon Legend",
            minHeight: 550,
            maxHeight: $(window).height() * 0.9,
            maxWidth: 100
        }).dialog("open");
    })

    // "Options"

    $("#ys-options-menu-item").click(function() {
        $(".dropdown").removeClass("active");
        $("#ys-nc-options-dialog").dialog({
            title: "NETCONF Options",
            maxHeight: $(window).height() * 0.9,
            width: "auto",
        }).dialog("open");
    });

    $("#ys-replay-dir-btn").click(function(e) {
        tasks.setTopReplayDir();
    });

    $("#ys-reset-replay-dir-btn").click(function(e) {
        tasks.resetTopReplayDir();
    });

    $('input[name="hide-nodes"]').change(netconf.filterNodes);

    $("#ys-rpctype").change(function(e) {
        if ($("#ytool-rpc-data").val() != "") {
            let gentype = $("#ys-rpctype").val();
            let prefixes = $("[name=ys-rpcprefixes]:checked").val();
            $("#ytool-rpc-data").val('');
            rpcmanager.reloadrpcs(gentype, prefixes);
        }
    });

    $('input[name="ys-rpcprefixes"]').change(function(e) {
        if ($("#ytool-rpc-data").val() != "") {
            let gentype = $("#ys-rpctype").val();
            let prefixes = $("[name=ys-rpcprefixes]:checked").val();
            $("#ytool-rpc-data").val('');
            rpcmanager.reloadrpcs(gentype, prefixes);
        }
    });

    $("#ys-logging").on("change", function(e) {
      netconf.setLoggingLevel();
    });

    // "Clear Values and Operations"

    $("#ys-clear-grid-menu-item").click(function() {
        $(".dropdown").removeClass("active");
        rpc_ui.clearGrid();
    });

    /***************************
     * "Build RPC" button
     ***************************/

    $("#ys-build-rpc-btn").on("click", function(e) {
        if (!$("#tree").jstree(true)) {
            popDialog("<p>To construct an RPC, please:</p><ol>" +
                      "<li>select a YANG set</li>" +
                      "<li>load at least one YANG module</li>" +
                      "<li>select a NETCONF operation</li>" +
                      "<li>specify at least one node value</li></ol>");
            return;
        }

        let operation = $("#ys-proto-op").val();
        let gentype = $("#ys-rpctype").val();
        let prefixes = $("[name=ys-rpcprefixes]:checked").val();
        var commit = "";
        switch (operation) {
          case "get-config":
              rpcmanager.config.datastoreGroup = "#ys-gc-datastore-group";
              break;
          case "edit-config":
              let datastore = $("#ys-ec-datastore-group .btn.selected").attr('data-value');
              commit = (datastore == "candidate" && $("#ys-ec-add-commit").is(":checked"));
              commit = commit ? "add" : "";
              rpcmanager.config.datastoreGroup = "#ys-ec-datastore-group";
              break;
          // Placeholders in case they need extra setup some day
          case "get":
          case "action":
          case "rpc":
        }
        rpcmanager.addrpc($("#tree"), gentype, commit, prefixes);
        $(".dropdown").removeClass("active");
    });

    $("#ys-rpc-options-btn").on("click", function(e) {
      let operation = $("#ys-proto-op").val();
        switch (operation) {
        case "edit-config":
            netconf.config.datastoreGroup = "#ys-ec-datastore-group";
            netconf.config.datastoreGroupButtons = "#ys-ec-datastore-group .btn";
            netconf.getDatastores();
            $("#ys-build-edit-config-dialog")
                    .dialog({modal: true})
                    .dialog("open");
            break;
        case "get-config":
            netconf.config.datastoreGroup = "#ys-gc-datastore-group";
            netconf.config.datastoreGroupButtons = "#ys-gc-datastore-group .btn";
            rpcmanager.config.withDefaultsSelect = "#ys-gc-with-defaults";
            netconf.getDatastores();
            $("#ys-build-get-config-dialog")
                    .dialog({modal: true})
                    .dialog("open");
            break;
        case "get":
            rpcmanager.config.withDefaultsSelect = "#ys-get-with-defaults";
            netconf.getDatastores();
            $("#ys-build-get-dialog").dialog({modal: true}).dialog("open");
            break;
        }
    });

    $("#ys-build-edit-config-dialog").dialog({
        title: "Configuring <edit-config> RPC",
        autoOpen: false,
        width: "auto",
        buttons: {
            "Continue": function() {
                $(this).dialog("close");
            },
        },
    });

    $("#ys-ec-datastore-group .btn").click(function(e) {
        if ($(this).hasClass("disabled")) {
            return;
        }
        if ($(this).hasClass("selected")) {
            return;
        }
        $("#ys-ec-datastore-group .btn").removeClass("selected");
        $(this).addClass("selected");
    });

    $("#ys-build-get-config-dialog").dialog({
        title: "Configuring <get-config> RPC",
        autoOpen: false,
        width: "auto",
        buttons: {
            "Continue": function() {
                $(this).dialog("close");
            },
        },
    });

    $("#ys-gc-datastore-group .btn").click(function(e) {
        if ($(this).hasClass("disabled")) {
            return;
        }
        if ($(this).hasClass("selected")) {
            return;
        }
        $("#ys-gc-datastore-group .btn").removeClass("selected");
        $(this).addClass("selected");
    });

    $("#ys-build-get-dialog").dialog({
        title: "Configuring <get> RPC",
        autoOpen: false,
        width: "auto",
        buttons: {
            "Continue": function() {
                $(this).dialog("close");
            },
        },
    });

    // No dialog needed for "action" or "rpc" types yet.

    /***************************
     * "Replays" menu
     ***************************/

    // "Load Replay"

    $("#ys-load-replay-menu-item").click(function() {
        $(".dropdown").removeClass("active");
        tasks.getTasks().then(function() {
            $("#ys-load-replay-dialog").dialog({
                title: 'Select replay to load',
                width: 600,
                minHeight: 600,
                buttons: [
                    {
                        text: 'Delete Replay',
                        icons: {primary: 'ui-icon-trash'},
                        class: 'btn-negative',
                        click: function() {
                            if (!$("#ytool-task-list").val()) {
                                popDialog("No task to delete");
                                return;
                            }

                            if (confirm('Really delete replay "' +
                                        $("#ytool-task-list").val() +
                                        '"?\nWARNING: This action is not reversible.')) {
                                tasks.deleteTask($("#ytool-task-list").val(),
                                                 $("#ys-replay-cat-list").val());
                            }
                        },
                    },
                    {
                        text: 'Run Replay',
                        icons: {primary: 'ui-icon-play'},
                        click: function() {
                            if (!$("#ytool-task-list").val()) {
                                popDialog("No task to run");
                                return;
                            }
                            if (!$("#ys-devices-replay").val()) {
                              popDialog("No device selected");
                              return;
                            }
                            rpcmanager.config.datastoreGroup = "#ys-replay-datastore-group";
                            rpcmanager.runtask($("#ytool-task-list").val(),
                                               $("#ys-replay-cat-list").val(),
                                               tasks.replayVariables('retrieve'));
                        },
                    },
                    {
                        text: 'Show Replay',
                        click: function() {
                            if (!$("#ytool-task-list").val()) {
                                popDialog("No task to load");
                                return;
                            }
                            $("#ytool-rpc-data").val('');
                            rpcmanager.config.datastoreGroup = "#ys-replay-datastore-group";
                            /* Load the NETCONF RPC representation of the replay */
                            rpcmanager.loadtask($("#ytool-task-list").val(),
                                                $("#ys-rpctype").val(),
                                                $("#ys-replay-cat-list").val(),
                                                tasks.replayVariables('retrieve'));
                            /* Load the raw replay data into the jstree */
                            $("#ytool-rpc-data").val('').addClass("source-of-truth");
                            $(".jstree-grid-wrapper").removeClass("source-of-truth");
                            tasks.getTask($("#ytool-task-list").val(),
                                          $("#ys-replay-cat-list").val(),
                                          netconf.populateReplay);
                            $(".ys-replay-required").removeClass("disabled");
                            $(this).dialog("close");
                        },
                    },
                ],
            }).dialog("open");
        });
      $("#tree").jstree(true).refresh();
    });

    $("#ys-replay-datastore-group .btn").click(function(e) {
        if ($(this).hasClass("disabled")) {
            return;
        }
        if ($(this).hasClass("selected")) {
            return;
        }
        $("#ys-replay-datastore-group .btn").removeClass("selected");
        $(this).addClass("selected");
    });

    $("#ys-add-var-row").click(function(e) {
        tasks.replayVariables('add');
    });

    $("#ys-clear-var-row").click(function(e) {
        updateVariablesAndValues();
    });

    $("#ys-save-variables").click(function() {
        if (!$("#ys-devices-replay").val()) {
            popDialog("Select a device profile to save the variables to.");
            return;
        }

        variables = tasks.replayVariables('retrieve');
        if (Object.keys(variables).length == 0) {
            popDialog("No variable values to save.");
            return;
        }

        devices.getDevice($("#ys-devices-replay").val()).then(function(retObj) {
            for (let key of Object.keys(variables)) {
                retObj.device.base.variables[key] = variables[key];
            }
            devices.updateDevice($("#ys-devices-replay").val(),
                                 JSON.stringify(retObj.device))
                .then(function() {
                    popDialog("Device " + $("#ys-devices-replay").val() + " updated.");
                });
        }, function(retObj) {
            popDialog("Error " + retObj.status + ": " + retObj.statusText);
        });
    });

    // "Save as New Replay"

    $("#ys-save-as-replay-menu-item").click(function() {
        $(".dropdown").removeClass("active");
        tasks.getSaveDialog();
    });

    // "Edit Replay Properties"

    $("#ys-edit-replay-menu-item").click(function() {
        if (!$("#ytool-task-list").val()) {
            popDialog("No replay to edit");
            return;
        }

        tasks.getEditDialog($("#ytool-task-list").val(),
                            $("#ys-replay-cat-list").val());
        $(".dropdown").removeClass("active");
    });

    // "Save Changes"

    $("#ys-save-replay-menu-item").click(function() {
        if (!$("#ytool-task-list").val()) {
            popDialog("No replay to edit")
            return;
        }
        tasks.updateTaskData();
        $(".dropdown").removeClass("active");
    });

    // "Generate Python Script"

    $("#ys-generate-python-menu-item").click(function() {
        rpcmanager.downloadScript();
        $(".dropdown").removeClass("active");
    });

    /***************************
     * "Run RPCs" button
     ***************************/

    $("#ys-run-rpcs-btn").click(function(e) {
        $(".dropdown").removeClass("active");

        let device = $("#ys-devices-replay").val();
        if (!device) {
            popDialog("Choose a device");
            return;
        }

        if ($("#ytool-rpc-data").hasClass("source-of-truth") &&
            $("#ytool-rpc-data").val()) {
            rpcmanager.runrpc(device, $("#ytool-rpc-data").val(), true);
            rpcmanager.openDeviceWindow(device, 1500);
        } else if (rpcmanager.config.savedrpcs.length > 0) {
            rpcmanager.runrpc(device, rpcmanager.config.savedrpcs, false);
            rpcmanager.openDeviceWindow(device, 1500);
        }
    });

    /***************************
     * "Clear RPCs" button
     ***************************/

    $("#ys-clear-rpcs-btn").click(function(e) {
        rpcmanager.clearrpcs();
        $("#ytool-rpc-data").val('').removeClass("source-of-truth");
        $(".jstree-grid-wrapper").addClass("source-of-truth");
        $(".dropdown").removeClass("active");
    });

    /***************************
     * User edits the replay XML directly
     ***************************/

    $("#ytool-rpc-data").change(function() {
        $("#ytool-rpc-data").addClass("source-of-truth");
        $(".jstree-grid-wrapper").removeClass("source-of-truth");
    });

    /*****************************
     *  Post-page-setup actions
     ****************************/

    if ($("#ys-devices-replay").val()) {
        $("#ys-devices-replay").trigger("change");
    }
});
</script>
{% endblock script %}
